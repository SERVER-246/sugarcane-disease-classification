# ============================================================================
# DISEASE Classification Pipeline - Python Version Test Matrix
# ============================================================================
# Created: Sprint 2 - CI/CD Without Behavior Change
# Triggers: Nightly at 2 AM UTC, manual dispatch
# Purpose: Test across Python 3.9, 3.10, 3.11, 3.12 on Ubuntu and Windows
# ============================================================================

name: Test Matrix (Nightly)

on:
  schedule:
    - cron: "0 2 * * *"  # 2 AM UTC daily
  workflow_dispatch:  # Allow manual triggering

env:
  PYTHONIOENCODING: utf-8
  PYTHONDONTWRITEBYTECODE: 1

jobs:
  # ===========================================================================
  # Multi-Python Version Test Matrix
  # ===========================================================================
  test-matrix:
    name: Test (Python ${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install PyTorch (CPU)
        run: pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install -r requirements-dev.txt

      - name: Run import validation
        run: |
          python -c "from Base_backbones import BACKBONES; print(f'✅ Python ${{ matrix.python-version }}: {len(BACKBONES)} backbones')"

      - name: Run tests
        run: pytest tests/ -v --tb=short

      - name: Run model creation smoke test
        run: |
          python -c "
          from Base_backbones import create_custom_backbone
          model = create_custom_backbone('CustomConvNeXt', 13)
          import torch
          x = torch.randn(1, 3, 224, 224)
          model.eval()
          with torch.no_grad():
              out = model(x)
          print(f'✅ Python ${{ matrix.python-version }}: Forward pass OK, output shape {out.shape}')
          "

  # ===========================================================================
  # Summary Report
  # ===========================================================================
  matrix-summary:
    name: Matrix Summary
    needs: [test-matrix]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# Test Matrix Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Python | Ubuntu | Windows |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| 3.9 | ${{ needs.test-matrix.result }} | ${{ needs.test-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3.10 | ${{ needs.test-matrix.result }} | ${{ needs.test-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3.11 | ${{ needs.test-matrix.result }} | ${{ needs.test-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3.12 | ${{ needs.test-matrix.result }} | ${{ needs.test-matrix.result }} |" >> $GITHUB_STEP_SUMMARY
